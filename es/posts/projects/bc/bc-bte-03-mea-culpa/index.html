<!doctype html><html xmlns=http://www.w3.org/1999/xhtml><head><script defer language=javascript type=text/javascript src=https://camagri.github.io/js/light_dark.js></script>
<script defer language=javascript type=text/javascript src=https://camagri.github.io/js/tabs.js></script>
<script defer language=javascript type=text/javascript src=https://camagri.github.io/js/katex.min.js></script>
<script defer language=javascript type=text/javascript src=https://camagri.github.io/js/auto-render.min.js></script>
<script defer language=javascript type=text/javascript src=https://camagri.github.io/js/katex.js></script>
<script defer language=javascript type=text/javascript src=https://camagri.github.io/js/toc.js></script><meta charset=utf-8><meta name=generator content="Hugo 0.110.0"><meta name=viewport content="width=device-width,initial-scale=1"><title>Detras de Escena - Parte 4 - Mea Culpa &#183; CaMaGri</title><meta name=description content><link type=text/css rel=stylesheet href=https://camagri.github.io/css/poole.css><link type=text/css rel=stylesheet href=https://camagri.github.io/css/syntax.css><link type=text/css rel=stylesheet href=https://camagri.github.io/css/hyde.css><link type=text/css rel=stylesheet href=https://camagri.github.io/css/poison.css><link type=text/css rel=stylesheet href=https://camagri.github.io/css/fonts.css><link type=text/css rel=stylesheet href=https://camagri.github.io/css/katex.min.css><link type=text/css rel=stylesheet href=https://camagri.github.io/css/tabs.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Mitr:wght@300&display=swap" rel=stylesheet><style>body{--sidebar-bg-color:#202020;--sidebar-img-border-color:#515151;--sidebar-p-color:#909090;--sidebar-h1-color:#FFF;--sidebar-a-color:#FFF;--sidebar-socials-color:#FFF;--text-color:#222;--bkg-color:#FAF9F6;--post-title-color:#303030;--list-color:#5a5a5a;--link-color:#268bd2;--date-color:#515151;--table-border-color:#E5E5E5;--table-stripe-color:#F9F9F9;--code-color:#bf616a;--code-background-color:#E5E5E5;--moon-sun-color:#FFF;--moon-sun-background-color:#515151}body.dark-theme{--text-color:#eee;--bkg-color:#121212;--post-title-color:#DBE2E9;--list-color:#9d9d9d;--link-color:#268bd2;--date-color:#9a9a9a;--table-border-color:#515151;--table-stripe-color:#202020;--code-color:#ff7f7f;--code-background-color:#393D47}body{background-color:var(--bkg-color)}</style></head><body class=dark-theme><aside class=sidebar><div class="container sidebar-sticky"><div class=light-dark><button class=btn-light-dark><svg class="moon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M6 .278a.768.768.0 01.08.858 7.208 7.208.0 00-.878 3.46c0 4.021 3.278 7.277 7.318 7.277.527.0 1.04-.055 1.533-.16a.787.787.0 01.81.316.733.733.0 01-.031.893A8.349 8.349.0 018.344 16C3.734 16 0 12.286.0 7.71.0 4.266 2.114 1.312 5.124.06A.752.752.0 016 .278z"/></svg><svg class="sun" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 16 16"><path fill="currentcolor" d="M8 12a4 4 0 100-8 4 4 0 000 8zM8 0a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 0zm0 13a.5.5.0 01.5.5v2a.5.5.0 01-1 0v-2A.5.5.0 018 13zm8-5a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2a.5.5.0 01.5.5zM3 8a.5.5.0 01-.5.5h-2a.5.5.0 010-1h2A.5.5.0 013 8zm10.657-5.657a.5.5.0 010 .707l-1.414 1.415a.5.5.0 11-.707-.708l1.414-1.414a.5.5.0 01.707.0zm-9.193 9.193a.5.5.0 010 .707L3.05 13.657a.5.5.0 01-.707-.707l1.414-1.414a.5.5.0 01.707.0zm9.193 2.121a.5.5.0 01-.707.0l-1.414-1.414a.5.5.0 01.707-.707l1.414 1.414a.5.5.0 010 .707zM4.464 4.465a.5.5.0 01-.707.0L2.343 3.05a.5.5.0 11.707-.707l1.414 1.414a.5.5.0 010 .708z"/></svg></button>
<button class=btn-en-es lang=es><div class=btn-es>ES</div><div class="btn-en active">EN</div></button></div><div class=sidebar-about><h1 class=brand><a href=https://camagri.github.io/es/><img src=/logo.jpeg alt="brand image"></a>
<a href=https://camagri.github.io/es/><h1>CaMaGri</h1></a></h1><p class=lead>team blog</p></div><nav><ul class=sidebar-nav><li class=heading><a href=#><span>Proyectos</span></a></li><ul class=sub-menu><li><a href=/es/posts/projects/bc/>BuccaneerCircus</a></li></ul><li class=bullet><a href=/es/about/><span>Nosotros</span></a></li></ul></nav><a target=_blank class=social href=https://github.com/camagri><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="-2 -2 24 24"><path fill="currentcolor" d="M18.88 1.099C18.147.366 17.265.0 16.233.0H3.746C2.714.0 1.832.366 1.099 1.099.366 1.832.0 2.714.0 3.746v12.487c0 1.032.366 1.914 1.099 2.647.733.733 1.615 1.099 2.647 1.099H6.66c.19.0.333-.007.429-.02a.504.504.0 00.286-.169c.095-.1.143-.245.143-.435l-.007-.885c-.004-.564-.006-1.01-.006-1.34l-.3.052c-.19.035-.43.05-.721.046a5.555 5.555.0 01-.904-.091 2.026 2.026.0 01-.872-.39 1.651 1.651.0 01-.572-.8l-.13-.3a3.25 3.25.0 00-.41-.663c-.186-.243-.375-.407-.566-.494l-.09-.065a.956.956.0 01-.17-.156.723.723.0 01-.117-.182c-.026-.061-.004-.111.065-.15.07-.04.195-.059.378-.059l.26.04c.173.034.388.138.643.311a2.1 2.1.0 01.631.677c.2.355.44.626.722.813.282.186.566.28.852.28.286.0.533-.022.742-.065a2.59 2.59.0 00.585-.196c.078-.58.29-1.028.637-1.34a8.907 8.907.0 01-1.333-.234 5.314 5.314.0 01-1.223-.507 3.5 3.5.0 01-1.047-.872c-.277-.347-.505-.802-.683-1.365-.177-.564-.266-1.215-.266-1.952.0-1.049.342-1.942 1.027-2.68-.32-.788-.29-1.673.091-2.652.252-.079.625-.02 1.119.175.494.195.856.362 1.086.5.23.14.414.257.553.352a9.233 9.233.0 012.497-.338c.859.0 1.691.113 2.498.338l.494-.312a6.997 6.997.0 011.197-.572c.46-.174.81-.221 1.054-.143.39.98.424 1.864.103 2.653.685.737 1.028 1.63 1.028 2.68.0.737-.089 1.39-.267 1.957-.177.568-.407 1.023-.689 1.366a3.65 3.65.0 01-1.053.865c-.42.234-.828.403-1.223.507a8.9 8.9.0 01-1.333.235c.45.39.676 1.005.676 1.846v3.11c0 .147.021.266.065.357a.36.36.0 00.208.189c.096.034.18.056.254.064.074.01.18.013.318.013h2.914c1.032.0 1.914-.366 2.647-1.099.732-.732 1.099-1.615 1.099-2.647V3.746c0-1.032-.367-1.914-1.1-2.647z"/></svg></a><a target=_blank class=social href=https://twitter.com/BuccaneerCircus><svg xmlns="http://www.w3.org/2000/svg" width="1.2em" height="1.2em" viewBox="0 0 16 16"><path fill="currentcolor" d="M5.032 14.286c6.037.0 9.34-4.837 9.34-9.032.0-.137.0-.274-.01-.41A6.56 6.56.0 0016 3.2c-.6.256-1.235.425-1.885.5a3.207 3.207.0 001.443-1.757c-.645.37-1.35.63-2.085.77a3.322 3.322.0 00-1.862-.958 3.384 3.384.0 00-2.082.334 3.223 3.223.0 00-1.442 1.49 3.08 3.08.0 00-.208 2.03 9.57 9.57.0 01-3.747-.963A9.269 9.269.0 011.114 2.292a3.086 3.086.0 00-.36 2.314c.189.787.68 1.475 1.376 1.924A3.344 3.344.0 01.64 6.132v.04c0 .734.263 1.444.743 2.01a3.3 3.3.0 001.89 1.102c-.483.128-.99.146-1.482.055a3.19 3.19.0 001.168 1.577 3.36 3.36.0 001.9.627A6.732 6.732.0 010 12.86a9.527 9.527.0 005.032 1.423"/></svg></a><p class=footnote>powered by <a target=_blank href=https://gohugo.io>Hugo</a> | themed with <a target=_blank href=https://github.com/lukeorth/poison>poison</a><br>&copy; 2023 CaMaGri. All rights reserved.</p></div></aside><main class="content container"><div class=post><div class=info><h1 class=post-title><a href=https://camagri.github.io/es/posts/projects/bc/bc-bte-03-mea-culpa/>Detras de Escena - Parte 4 - Mea Culpa</a></h1><time datetime=2023-02-19T10:11:45+0100 class=post-date>February 19, 2023</time></div><p>En esta sección vamos a analizar dos casos que hacen a la seguridad del proyecto. En el primero vamos a analizar un posible escenario de fraude que es importante tener presente para intentar evitarlo. En el segundo, vamos a analizar una vulnerabilidad que encontramos en el proyecto, que ya fue reparada, pero que nos pareció interesante compartir por su moraleja.</p><p>La idea detrás de <em>Mea Culpa</em> no es dar a conocer problemas que alguien pueda intentar utilizar para atacarnos, sino ser transparentes con las dificultades que el proyecto presentó, cómo se solucionaron y para esos casos en donde el escenario sigue vigente, dar herramientas y hacer conscientes a los usuarios para que ellos tengan la posibilidad de evitarlos.
Esconder los problemas nunca es buena idea.</p><h2 id=frontrun-en-las-transferencias>FrontRun en las transferencias</h2><p>Supongamos el siguiente escenario: Bob tiene un token que pertenece al grupo A de los tokens que delatan al capitán #5 y nosotros tenemos un token del grupo B para el mismo capitán. El capitán #5 aún no fue reclamado por lo que nosotros queremos comprar el token de Bob para poder ejecutar el reclamo. Bob nos lo vende por alguna plataforma de Marketplace pero cuando lo recibimos nos damos cuenta que el capitán #5 ya fue reclamado por el mismo Bob. Que paso?</p><p>Claro que para que esto ocurra Bob tiene que haber tenido también un token del grupo B para el capitán #5, sino no podría ocurrir.</p><p>Lo que Bob hizo fue esperar que nosotros iniciemos la compra del token y que la transacción de esa operación se envíe al Pool de transacciones de Ethereum. Las transacciones en el pool de Ethereum son transacciones pendientes de ser ejecutadas pero aún no fueron incluidas en ningún bloque por lo que el token, hasta que esa transacción no esté en la Blockchain, sigue siendo de Bob.<br>De forma automática y como respuesta al inicio de la compra, Bob lanzó otra transacción pero en este caso para reclamar el token #5. Para asegurarse que su transacción se ejecute primero, Bob ha pagado más <strong>maxPriorityFeePerGas</strong> que el pagado por nosotros, priorizando así su transacción sobre la nuestra. Al cabo de un rato, su transacción fue incluida mientras la nuestra espera y para cuando la nuestra es finalmente incluida en un bloque de la Blockchain, el token del capitán #5 por el que compramos ese token a Bob, ya no está disponible y lo tiene Bob. Entonces Bob no solo se hizo con el capitán #5 sino que también realizó una venta en el proceso. Esto es lo que se conoce en la seguridad de Blockchains como <strong>FrontRun</strong>.</p><p>Si bien es un escenario un poco difícil de darse , no es imposible. El mayor riesgo que corre Bob es que alguien mas reclame el capitan #5 mientras él espera la venta de su token.</p><p>Como parte del proyecto existe un panel llamado <a href=https://www.buccaneercircus.io/registry.html>Rovers Registry</a> que expone de forma sintética toda la información que pueda hacer falta conocer sobre el estado de <em>BuccaneerCircus</em> y sus contratos, quien tiene qué tokens, el estado de los mismos y la posibilidad de consultar cierta información. Todo esto puede darnos algo de ayuda al momento de querer concretar una operación ya que, si por ejemplo, Bob tuviese los dos tokens necesarios para hacer un reclamo, esto se podría saber utilizando el panel y eso ya sería algo sospechoso. Existen de cualquier manera, algunas otras tretas que Bob podría realizar para evitar esos chequeos, pero haría algo más complejo su fraude.</p><p>Rovers Registry se encuentra en funcionamiento pero aún lo seguimos mejorando con más funcionalidades.</p><h2 id=vulnerabilidad-en-cleanpayments>Vulnerabilidad en cleanPayments()</h2><p>Todas las funciones de todos los contratos de <em>BuccaneerCircus</em> fueron auditadas varias veces antes de ser puestas en funcionamiento en la mainnet de Ethereum, pero a veces los problemas igual ocurren. Por suerte el problema pudo ser resuelto y hoy es una anécdota interesante para contar, no solo como una autocrítica sino también para mostrar que los errores ocurren y que la seguridad es una de nuestras prioridades.</p><p>La función <em>cleanPayments()</em> descrita durante el análisis del contrato <em>MarquisBanquete.sol</em> es la versión corregida de la que fue la función original, la cual se veía así:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-solidity data-lang=solidity><span style=display:flex><span><span style=color:#ae81ff>238</span>   <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>cleanPayments</span>() <span style=color:#66d9ef>public</span> {
</span></span><span style=display:flex><span><span style=color:#ae81ff>239</span>       <span style=color:#66d9ef>uint256</span> paymentIndex <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#ae81ff>240</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>241</span>       <span style=color:#66d9ef>while</span>(paymentIndex <span style=color:#f92672>&lt;</span> allPaymentIds.length) {
</span></span><span style=display:flex><span><span style=color:#ae81ff>242</span>           Payment <span style=color:#66d9ef>memory</span> _payment <span style=color:#f92672>=</span> payments[allPaymentIds[paymentIndex]];
</span></span><span style=display:flex><span><span style=color:#ae81ff>243</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>244</span>           <span style=color:#66d9ef>if</span>(_payment.expirationBlock <span style=color:#f92672>&gt;=</span> block.number) {
</span></span><span style=display:flex><span><span style=color:#ae81ff>245</span>               paymentIndex<span style=color:#f92672>++</span>;
</span></span><span style=display:flex><span><span style=color:#ae81ff>246</span>               <span style=color:#66d9ef>continue</span>;
</span></span><span style=display:flex><span><span style=color:#ae81ff>247</span>           }
</span></span><span style=display:flex><span><span style=color:#ae81ff>248</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>249</span>           allPaymentIds[paymentIndex] <span style=color:#f92672>=</span> allPaymentIds[allPaymentIds.length <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span><span style=color:#ae81ff>250</span>           allPaymentIds.pop();
</span></span><span style=display:flex><span><span style=color:#ae81ff>251</span>
</span></span><span style=display:flex><span><span style=color:#ae81ff>252</span>           bountyBalance <span style=color:#f92672>+=</span> _payment.amount;
</span></span><span style=display:flex><span><span style=color:#ae81ff>253</span>       }
</span></span><span style=display:flex><span><span style=color:#ae81ff>254</span>   }
</span></span></code></pre></div><p>Esta versión no parece muy diferente a la actual, pero tiene una diferencia clave: Borrar y Reembolsa en el bounty todos aquellos pagos que, como única condición, hayan expirado.</p><p>El problema ocurrió puntualmente al agregar la línea 252 al contrato sin estudiar sus implicancias. Sin esa línea, la función simplemente elimina todos los <em>Payments</em> expirados, pero aquellos que no habían sido pagados pero sí aprobados, generan un desbalance en el contrato que hacía que el mismo finalmente tuviese más Ethereum del que se podía disponer, el cual no se iba a poder recuperar.</p><p>Con la línea 252 se pretendía reembolsar ese Ethereum al bounty pero se introdujo una vulnerabilidad en el proceso. Con esa linea, ahora los pagos expirados, pagados o no, aprobado o no, eran reembolsados, permitiendo a un atacante por ejemplo, incrementar de forma arbitraria el valor de la variable <em>bountyBalance</em> y en una invocación a <em>shuffle()</em> obtener el 1% de esta variable por llave a procesar pero extrayendo mucho más en el proceso que lo que realmente corresponde.</p><p>Este fue el único cambio existente de este tipo en los contratos, pero sirve para dejar claro que los contratos deben ser muy bien observados, incluso ante los cambios más minúsculos.</p><h2 id=conclusion>Conclusion</h2><p><em>BuccaneerCircus</em> es un proyecto que nos dejó muchas experiencias en todo lo que implicó, y alimentó en el proceso nuestro gusto por estas tecnologías. La idea es seguir construyendo sobre esto muchas más cosas y poder, como intentamos hacer hasta aquí, compartir con todos la experiencia lograda en el desarrollo.</p><hr><div class=footer><a class=previous-post href="https://camagri.github.io/es/posts/projects/bc/bc-bte-02c-thesunkenlegend/?ref=footer">« Detras de Escena - Parte 3C - TheSunkenLegend.sol</a></div><div class=article-toc><h4></h4><nav id=TableOfContents><ul><li><a href=#frontrun-en-las-transferencias>FrontRun en las transferencias</a></li><li><a href=#vulnerabilidad-en-cleanpayments>Vulnerabilidad en cleanPayments()</a></li><li><a href=#conclusion>Conclusion</a></li></ul></nav></div></div></main></body></html>